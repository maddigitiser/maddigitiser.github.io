{"name":"Creating a new domain on Windows Azure","tagline":"","body":"# Creating a new domain on Windows Azure\r\nI've spent a few hours in the past week getting a domain set up on Azure with the aim of using it to test some integration tools.  There's some guides out there that give you tips, but I found a couple of technical errors, plus they didn't detail a full solution end-to-end.  My approach had to be repeatable so it uses Powershell - you'll need the the Azure SDK to installed to run these steps. \r\n\r\n### Creating the machine\r\n\r\n```\r\ncls\r\n\r\nImport-Module \"C:\\Program Files (x86)\\Microsoft SDKs\\Windows Azure\\PowerShell\\Azure\\Azure.psd1\"\r\nImport-AzurePublishSettingsFile 'MyAzureSettings.publishsettings'\r\nSet-AzureSubscription -SubscriptionName '{subscription name}' -CurrentStorageAccount '{storage account}'\r\nSelect-AzureSubscription -SubscriptionName '{subscription name}'\r\n\r\n#Deploy the Domain Controller in a virtual network\r\n#-------------------------------------------------\r\n\r\n\r\n#Specify my DC's DNS IP (127.0.0.1)\r\n$myDNS = New-AzureDNS -Name 'MyThrowawayInternalDnsName' -IPAddress '127.0.0.1'\r\n$vmname = 'MyMachineName'\r\n# OS Image to Use\r\n$image = 'a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201303.01-en.us-127GB.vhd'\r\n$AG = 'MyAffinityGroup'\r\n$vnet = 'MyVNet'\r\n\r\n\r\n#VM Configuration\r\n$MyDC = New-AzureVMConfig -name $vmname -InstanceSize 'Small' -ImageName $image |\r\n    Add-AzureProvisioningConfig -Windows -Password '{password}' |\r\n        Set-AzureSubnet -SubnetNames '{subnet name}'\r\n\r\n\r\nNew-AzureVM -ServiceName $vmname -AffinityGroup $AG -VMs $MyDC -DnsSettings $myDNS -VNetName $vnet\r\n```\r\n\r\nYour domain controller should now be spinning up - when it's done, you should install the AD DS role.  The walk though is here http://technet.microsoft.com/en-us/library/hh472162.aspx.  The easiest way is probably with Server Manager.\r\n\r\n### Creating a joined machine \r\n\r\nNow that's set up, we can create a new machine and join it to the domain.  \r\n\r\n```\r\n#Deploy a new VM and join it to the domain\r\n#-------------------------------------------\r\n#Specify my DC's DNS IP\r\n$myDNS = New-AzureDNS -Name 'MyThrowawayInternalDnsName' -IPAddress '{vnet ipv4 address of my DC}'\r\n\r\n\r\n# OS Image to Use\r\n$image = 'a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201303.01-en.us-127GB.vhd'\r\n$admin = '{my domain admin}'\r\n$pwd = '{my domain admin password}'\r\n$size = 'Small'\r\n\r\n\r\n#VM Configuration\r\n$vmname = '{my domain machine}'\r\n$MyVM1 = New-AzureVMConfig -name $vmname -InstanceSize $size -ImageName $image |\r\n    Add-AzureProvisioningConfig -WindowsDomain -Password $pwd -Domain '{my domain}.com' -DomainPassword $pwd -DomainUserName $admin -JoinDomain '{my domain}.com'|\r\n    Set-AzureSubnet -SubnetNames '{subnet name}'\r\n\r\n\r\nNew-AzureVM -ServiceName $vmname -AffinityGroup $AG -VMs $MyVM1 -DnsSettings $myDNS -VNetName $vnet\r\n```\r\n\r\nThat should spin up a new machine that's domain-joined!\r\n\r\n### Setting up some users\r\n\r\nWhile we're here - let's create some users in our new directory.  If you want to do this from your workstation (as opposed to on our domain-joined machine) you'll need to open an endpoint in Azure to your DC's 9389 port - the port that listens for AD web services.\r\n\r\nI've allowed accidental deletion of these OUs so I can easily delete them afterwards.\r\n\r\n```\r\n$secpw = ConvertTo-SecureString \"{my domain admin password}\" -AsPlainText -Force\r\n$cred = New-Object System.Management.Automation.PSCredential(\"{my domain admin}\", $secpw)\r\n\r\nWrite-Host \"Connecting with admin account\"\r\n\r\nNew-ADOrganizationalUnit -Name \"Nova Laboratories\" -Path \"DC={my domain},DC=com\" -Server {my dc}.cloudapp.net -Credential $cred -ProtectedFromAccidentalDeletion  $false\r\n\r\nWrite-Host \"Created OU Nova Laboratories\"\r\n\r\nNew-ADOrganizationalUnit  -Name \"Robots\" -Path \"OU=Nova Laboratories,DC={my domain},DC=com\" -Server {my dc}.cloudapp.net -Credential $cred -ProtectedFromAccidentalDeletion $false\r\n\r\nWrite-Host \"Created OU Robots in Nova Laboratories\"\r\n\r\nfor($i = 1; $i -lt 101; $i++){\r\nNew-ADUser \"Johnny$i\" `\r\n    -Path \"OU=Robots,OU=Nova Laboratories,DC={my domain},DC=com\" `\r\n    -DisplayName \"Johnny $i\" `\r\n    -GivenName \"Johnny\" `\r\n    -Surname $i `\r\n    -Company \"Nova Laboratories\" `\r\n    -Server {my dc}.cloudapp.net `\r\n    -Credential $cred\r\n    \r\n    Write-Host \"Creating User Johnny$i in Nova Laboratories Robots\"\r\n}\r\n\r\n```\r\n\r\nYou should now (hopefully) have a simple domain set up, with a joined machine and a group of users.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}