<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Creating a new domain on Windows Azure by maddigitiser</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Creating a new domain on Windows Azure</h1>
        <p></p>


        <p class="view"><a href="https://github.com/maddigitiser">View My GitHub Profile</a></p>

      </header>
      <section>
        <h1>Creating a new domain on Windows Azure</h1>

<p>I've spent a few hours in the past week getting a domain set up on Azure so I can do some testing for some software I'm writing to control directory sync with Office 365 (in particular, Azure Active Directory).  There's some guides out there that give you some tips, but I found some technical errors in them and they didn't detail the full solution end-to-end.  My approach had to be repeatable so it focuses on Powershell - you'll need the the Azure SDK to installed to run these steps.  For the record, joining a new Azure VM a domain is far, far easier using PS than the portal.  </p>

<h3>Creating the machine</h3>

<pre><code>cls

Import-Module "C:\Program Files (x86)\Microsoft SDKs\Windows Azure\PowerShell\Azure\Azure.psd1"
Import-AzurePublishSettingsFile 'MyAzureSettings.publishsettings'
Set-AzureSubscription -SubscriptionName '{subscription name}' -CurrentStorageAccount '{storage account}'
Select-AzureSubscription -SubscriptionName '{subscription name}'

#Deploy the Domain Controller in a virtual network
#-------------------------------------------------


#Specify my DC's DNS IP (127.0.0.1)
$myDNS = New-AzureDNS -Name 'MyThrowawayInternalDnsName' -IPAddress '127.0.0.1'
$vmname = 'MyMachineName'
# OS Image to Use
$image = 'a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201303.01-en.us-127GB.vhd'
$AG = 'MyAffinityGroup'
$vnet = 'MyVNet'


#VM Configuration
$MyDC = New-AzureVMConfig -name $vmname -InstanceSize 'Small' -ImageName $image |
    Add-AzureProvisioningConfig -Windows -Password '{password}' |
        Set-AzureSubnet -SubnetNames '{subnet name}'


New-AzureVM -ServiceName $vmname -AffinityGroup $AG -VMs $MyDC -DnsSettings $myDNS -VNetName $vnet
</code></pre>
      </section>
      <footer>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>